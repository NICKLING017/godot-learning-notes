# 吸血鬼幸存者项目实战总结

## 项目概述

基于 Godot 4.x 开发的 Vampire Survivors 风格 Roguelite 游戏。

## 架构特点

### 1. 组合优于继承

```
CharacterBody2D（玩家/敌人）
├── HealthComponent      # 生命值
├── VelocityComponent    # 移动
├── HitBoxComponent      # 攻击判定
├── HurtBoxComponent     # 受击判定
└── DeathComponent       # 死亡处理
```

### 2. 信号解耦

```
GameEvents（事件总线）
├── experience_vial_collected  # 经验收集
├── ability_upgrade_added      # 升级获得
├── player_damaged             # 玩家受伤
└── damage_dealt               # 造成伤害
```

### 3. 数据驱动

```
Resources/
├── upgrades/
│   ├── sword_damage.tres
│   ├── sword_cooldown.tres
│   └── ...
└── meta_upgrades/
    └── ...
```

## 核心系统

| 系统 | 职责 | 关键技术 |
|------|------|----------|
| 组件系统 | 通用功能复用 | 组合模式 |
| 敌人生成 | 刷怪与难度 | 权重表 + 射线检测 |
| 技能系统 | Controller-Ability 分离 | 信号 + PackedScene |
| 升级系统 | 随机选择 | Resource + 字典 |
| 存档系统 | 持久化 | FileAccess + user:// |

## 关键代码模式

### 延迟销毁

```gdscript
func damage(amount: float) -> void:
    current_health -= amount
    if current_health <= 0:
        Callable(check_death).call_deferred()
```

### 距离优化

```gdscript
# 使用 distance_squared_to
if enemy.global_position.distance_squared_to(player.global_position) < pow(range, 2):
    # ...
```

### 射线检测

```gdscript
var query = PhysicsRayQueryParameters2D.create(start, end, collision_mask)
var result = space_state.intersect_ray(query)
```

### 权重随机

```gdscript
var enemy_table = WeightedTable.new()
enemy_table.add_item(enemy_scene, weight)
var scene = enemy_table.pick_item()
```

## 学到的知识点

### 1. Godot 特有
- `@export` 导出变量
- `class_name` 定义类名
- `preload()` 预加载资源
- `instantiate()` 实例化场景
- `is_in_group()` 分组管理
- `get_first_node_in_group()` 获取组内节点
- `queue_free()` 延迟销毁

### 2. 设计模式
- 组件模式（Component Pattern）
- 事件总线（Event Bus）
- 数据驱动（Data-Driven）
- 服务定位器（Service Locator，通过 Autoload）

### 3. 性能优化
- `distance_squared_to` 替代 `distance_to`
- `call_deferred` 延迟执行
- `Callable` 作为一等公民

### 4. 游戏开发
- 难度曲线设计
- 随机权重表
- 索敌与范围检测
- 存档与持久化

## 可改进方向

### 1. 架构层面
- [ ] 使用子场景（SubScene）管理复杂实体
- [ ] 引入 ECS（Entity Component System）
- [ ] 实现对象池（Object Pool）减少实例化开销

### 2. 性能层面
- [ ] 敌人使用分区域管理（空间划分）
- [ ] 技能特效使用 GPU 实例化
- [ ] 实现 LOD（Level of Detail）

### 3. 功能层面
- [ ] 成就系统
- [ ] 本地化支持
- [ ] 每日挑战/赛季系统

## 总结

本项目展示了 **Godot 4.x 的最佳实践**：
- 清晰的目录结构
- 组件化设计
- 信号解耦
- 数据驱动
- 性能意识

是一个值得学习的 **中等规模游戏项目模板**。
