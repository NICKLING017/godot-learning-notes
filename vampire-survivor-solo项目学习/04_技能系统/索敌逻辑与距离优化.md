# 索敌逻辑与距离优化

## 索敌需求

在范围内找到最近的敌人，作为技能目标。

## 基础实现

```gdscript
func find_closest_enemy(enemies: Array[Node]) -> Node2D:
    var closest_enemy: Node2D = null
    var closest_distance: float = INF

    for enemy in enemies:
        var distance = enemy.global_position.distance_to(owner.global_position)
        if distance < closest_distance:
            closest_distance = distance
            closest_enemy = enemy

    return closest_enemy
```

## 优化版本（使用 distance_squared_to）

```gdscript
func find_closest_enemy(enemies: Array[Node]) -> Node2D:
    var closest_enemy: Node2D = null
    var closest_distance_sq: float = INF

    for enemy in enemies:
        var distance_sq = enemy.global_position.distance_squared_to(owner.global_position)
        if distance_sq < closest_distance_sq:
            closest_distance_sq = distance_sq
            closest_enemy = enemy

    return closest_enemy
```

## Godot 项目中的实现

```gdscript
# 筛选范围内的敌人
enemies = enemies.filter(func(enemy: Node2D):
    return enemy.global_position.distance_squared_to(player.global_position) < pow(MAX_RANGE, 2)
)

# 按距离排序
enemies.sort_custom(func(a: Node2D, b: Node2D):
    var a_distance = a.global_position.distance_squared_to(player.global_position)
    var b_distance = b.global_position.distance_squared_to(player.global_position)
    return a_distance < b_distance
)
```

## 距离计算对比

| 方法 | 计算量 | 适用场景 |
|------|--------|----------|
| `distance_to()` | 开方运算（较慢） | 需要真实距离值 |
| `distance_squared_to()` | 仅平方运算（更快） | 仅比较大小 |

```gdscript
# 性能对比
var a = Vector2(100, 100)
var b = Vector2(200, 200)

a.distance_to(b)        # 141.42...（开方）
a.distance_squared_to(b)# 20000（直接平方）

# 比较时等效
if a.distance_to(b) < 100: ...
if a.distance_squared_to(b) < 10000: ...
```

## 完整索敌流程

```gdscript
const MAX_RANGE: float = 150.0
const MAX_RANGE_SQ: float = 150.0 * 150.0

func get_target_enemy() -> Node2D:
    var enemies = get_tree().get_nodes_in_group("enemy")

    # 1. 范围筛选
    var in_range = enemies.filter(func(enemy: Node2D):
        return enemy.global_position.distance_squared_to(owner.global_position) < MAX_RANGE_SQ
    )

    if in_range.is_empty():
        return null

    # 2. 按距离排序
    in_range.sort_custom(func(a: Node2D, b: Node2D):
        var a_dist = a.global_position.distance_squared_to(owner.global_position)
        var b_dist = b.global_position.distance_squared_to(owner.global_position)
        return a_dist < b_dist
    )

    # 3. 返回最近的
    return in_range[0]
```

## 多目标技能

```gdscript
# 获取范围内 N 个敌人
func get_nearest_enemies(count: int) -> Array[Node2D]:
    var enemies = get_tree().get_nodes_in_group("enemy")

    var in_range = enemies.filter(func(enemy: Node2D):
        return enemy.global_position.distance_squared_to(owner.global_position) < MAX_RANGE_SQ
    )

    in_range.sort_custom(func(a: Node2D, b: Node2D):
        return a.global_position.distance_squared_to(owner.global_position) < \
               b.global_position.distance_squared_to(owner.global_position)
    )

    return in_range.slice(0, count)
```

## 最佳实践

1. **优先平方** - 距离比较用 distance_squared_to
2. **预计算** - pow(MAX_RANGE, 2) 在初始化时计算
3. **提前退出** - 找到目标后可以提前结束循环
4. **空检查** - 过滤后的数组可能为空
5. **Group 管理** - 用 get_nodes_in_group 获取敌人列表
